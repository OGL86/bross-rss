<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="BR√ÖSS! Studio Radar ‚Äî Live nyhetsdashbord for Nintendo og videospill. Aggregerer 20 RSS-kilder i sanntid.">
  <meta name="theme-color" content="#E60012">
  <meta property="og:title" content="BR√ÖSS! Studio Radar">
  <meta property="og:description" content="Live nyhetsdashbord for Nintendo og videospill podcast-produksjon.">
  <meta property="og:type" content="website">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî¥</text></svg>">
  <title>BR√ÖSS! Studio Radar</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

    /* ===== RESET & BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-color: #111;
      --card-bg: #1e1e1e;
      --card-border: #2a2a2a;
      --accent: #E60012;
      --text-main: #e0e0e0;
      --text-muted: #888;
      --font-stack: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      font-family: var(--font-stack);
      background: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      line-height: 1.4;
      font-size: 14px; /* Compact base size */
    }

    a { color: #fff; text-decoration: none; transition: color 0.2s; }
    a:hover { color: var(--accent); }

    /* ===== HEADER ===== */
    .header {
      background: rgba(17, 17, 17, 0.97);
      border-bottom: 1px solid #222;
      padding: 0.7rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }

    .header-branding { display: flex; align-items: baseline; gap: 0.8rem; }

    .header h1 {
      font-size: 1.3rem;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #fff;
      line-height: 1;
    }

    .header h1 span.accent { color: var(--accent); }

    .header .subtitle {
      font-size: 0.7rem;
      color: #555;
      letter-spacing: 0.3px;
      font-weight: 500;
    }

    /* ===== LOADING / STATUS ===== */
    #status-bar-container { margin-left: auto; }
    
    .status-bar {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
    }

    .status-bar.error { color: #ff5555; }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid #444;
      border-top-color: #E60012;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== GRID LAYOUT ===== */
    .grid-container {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 2rem;
      padding: 1rem 1.5rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    @media (max-width: 1100px) and (min-width: 700px) {
      .grid-container { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 699px) {
      .grid-container { grid-template-columns: 1fr; }
      .header h1 { font-size: 1.6rem; }
      .filter-bar { padding: 0.4rem 0.8rem; }
      .search-box { width: 100%; }
      .toolbar { flex-direction: column; gap: 0.5rem; }
    }

    .column {
      background: transparent;
      border-radius: 0;
      padding: 0;
      min-height: 300px;
    }

    .column-header {
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      padding-bottom: 0.6rem;
      margin-bottom: 0.6rem;
      border-bottom: 2px solid var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #999;
    }

    .column-header small {
      font-weight: 500;
      color: #555;
      letter-spacing: 0;
    }

    .column-header .count {
      background: var(--accent);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 9px;
      border-radius: 10px;
      margin-left: auto;
    }

    /* ===== NEWS CARDS ===== */
    .card {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 0.75rem 0.9rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid transparent;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: border-color 0.2s, background 0.15s, box-shadow 0.2s;
      display: flex;
      gap: 0.7rem;
      position: relative;
    }

    .card:hover {
      border-left-color: var(--accent);
      background: #242424;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .card.fire-card {
      border-left-color: var(--accent);
      background: linear-gradient(135deg, #2a1a1a 0%, #1e1e1e 100%);
    }

    .card.fire-card:hover {
      box-shadow: 0 2px 12px rgba(230, 0, 18, 0.2);
    }

    .card-body { flex: 1; min-width: 0; }

    .card-thumbnail {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      background: #2a2a2a;
      align-self: center;
    }

    .card-title {
      font-size: 0.88rem;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 0.3rem;
      color: #f0f0f0;
    }

    .card-title a { color: #f0f0f0; }
    .card-title a:hover { color: #fff; text-decoration: underline; }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.7rem;
      color: #666;
      flex-wrap: wrap;
      line-height: 1;
    }

    .card-source {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #999;
      font-size: 0.68rem;
      font-weight: 500;
    }

    .card-source img.favicon {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      opacity: 0.8;
    }

    .card-meta-separator {
      color: #444;
      font-size: 0.5rem;
    }

    .card-date { color: #555; font-size: 0.68rem; }

    /* ===== HYPE SCORE ===== */
    .hype-section {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-top: 0.35rem;
    }

    .hype-badge {
      font-weight: 700;
      font-size: 0.72rem;
      padding: 1px 7px;
      border-radius: 4px;
      min-width: 28px;
      text-align: center;
      color: #fff;
      transition: background 0.2s;
      line-height: 1.5;
    }

    .hype-low { background: #444; }
    .hype-med { background: #7a6520; }
    .hype-high { background: #982d24; }
    .hype-fire { background: var(--accent); }

    .hype-label {
      font-size: 0.65rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-weight: 600;
    }

    .hype-btn {
      background: transparent;
      color: #666;
      border: 1px solid #333;
      border-radius: 4px;
      min-width: 44px;
      min-height: 44px;
      width: 44px;
      height: 44px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      line-height: 1;
    }

    @media (min-width: 700px) {
      .hype-btn { min-width: 22px; min-height: 22px; width: 22px; height: 22px; font-size: 0.85rem; }
    }

    .hype-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* ===== FAVORITES BUTTON ===== */
    .favorites-section {
      text-align: center;
      padding: 1.2rem 1rem;
    }

    .favorites-btn {
      background: transparent;
      color: #ccc;
      border: 1px solid #333;
      padding: 0.6rem 1.8rem;
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      letter-spacing: 0.5px;
      transition: all 0.2s;
    }

    .favorites-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .favorites-btn:active { transform: scale(0.97); }

    .favorites-btn .fav-count {
      background: var(--accent);
      color: #fff;
      padding: 1px 7px;
      border-radius: 8px;
      font-size: 0.7rem;
      margin-left: 0.4rem;
      font-weight: 700;
    }

    /* ===== FAVORITES PANEL ===== */
    .results-container {
      max-width: 900px;
      margin: 0 auto 3rem;
      padding: 0 1.5rem;
      display: none;
    }

    .results-container.visible { display: block; }

    .results-box {
      background: linear-gradient(135deg, var(--card-bg) 0%, #151515 100%);
      border: 2px solid var(--accent);
      border-radius: 14px;
      padding: 1.5rem;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .results-header {
      font-size: 1.4rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 1.2rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.75rem 0.8rem;
      border-bottom: 1px solid #2a2a2a;
      transition: background 0.15s;
    }

    .result-item:hover { background: #252525; border-radius: 8px; }

    .result-item:last-child { border-bottom: none; }

    .result-rank {
      font-size: 1.1rem;
      font-weight: 900;
      color: var(--accent);
      min-width: 28px;
      text-align: center;
    }

    .result-info { flex: 1; }

    .result-title {
      font-size: 0.9rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .result-meta {
      font-size: 0.72rem;
      color: #888;
      margin-top: 0.15rem;
    }

    .result-actions {
      display: flex;
      gap: 0.3rem;
    }

    .result-action-btn {
      background: #333;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .result-action-btn:hover { background: var(--accent); color: #fff; }
    .result-action-btn.remove:hover { background: #c0392b; }

    body.high-contrast .result-action-btn { background: #ddd; color: #333; }

    .favorites-empty {
      text-align: center;
      color: #666;
      padding: 2rem;
      font-size: 0.9rem;
    }

    .favorites-toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .favorites-toolbar button {
      background: #333;
      border: none;
      color: #ccc;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .favorites-toolbar button:hover { background: var(--accent); color: #fff; }
    body.high-contrast .favorites-toolbar button { background: #ddd; color: #333; }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      color: #555;
      padding: 2rem 1rem;
      font-size: 0.85rem;
    }

    /* ===== FILTER BAR ===== */
    .filter-bar {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0.5rem 1.5rem 0.7rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      align-items: center;
      border-bottom: 1px solid #1e1e1e;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .filter-group-label {
      font-size: 0.65rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 0.15rem;
      white-space: nowrap;
      font-weight: 600;
    }

    .filter-chip {
      background: transparent;
      color: #777;
      border: 1px solid #333;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
      font-weight: 500;
    }

    .filter-chip:hover { border-color: #666; color: #ccc; }

    .filter-chip.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      font-weight: 600;
    }

    .filter-divider {
      width: 1px;
      height: 18px;
      background: #2a2a2a;
      margin: 0 0.2rem;
    }

    /* ===== CATEGORY TAGS ===== */
    .card-category {
      font-size: 0.6rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      line-height: 1;
    }

    .cat-nyheter    { background: #1e3450; color: #6aa8e0; }
    .cat-rykter     { background: #4a2a1e; color: #e89868; }
    .cat-anmeldelse { background: #1e4a2a; color: #68d888; }
    .cat-utgivelse  { background: #3e1e4a; color: #b868d8; }
    .cat-hardware   { background: #4a4a1e; color: #d8d868; }
    .cat-bransje    { background: #1e3e3e; color: #68c8c8; }
    .cat-salg       { background: #4a1e34; color: #d868a0; }
    .cat-video      { background: #381e1e; color: #d86868; }

    /* ===== FEED STATUS (modal) ===== */

    .feed-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.4rem;
      padding: 0.5rem 0;
    }

    .feed-status-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.7rem;
      color: #777;
      padding: 3px 6px;
      background: #1a1a1a;
      border-radius: 4px;
    }

    .feed-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
    }

    .feed-dot.ok { background: #4caf50; }
    .feed-dot.fail { background: #f44336; }
    .feed-dot.loading { background: #ffc107; animation: pulse 1s infinite; }

    @keyframes pulse { 50% { opacity: 0.4; } }

    .feed-count { color: #555; margin-left: auto; }

    /* ===== VIS MER ===== */
    .show-more-btn {
      display: block;
      width: 100%;
      background: transparent;
      border: 1px dashed #333;
      color: #666;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.75rem;
      text-align: center;
      margin-top: 0.5rem;
      transition: all 0.15s;
      font-weight: 500;
    }

    .show-more-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* ===== TOOLBAR ===== */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      padding: 0.5rem 1.5rem;
      background: transparent;
      border-bottom: none;
      flex-wrap: wrap;
      max-width: 1600px;
      margin: 0 auto;
    }

    .last-updated {
      font-size: 0.7rem;
      color: #444;
    }

    .refresh-btn {
      background: transparent;
      border: 1px solid #333;
      color: #777;
      padding: 4px 14px;
      border-radius: 8px;
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 500;
    }

    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
    .refresh-btn.spinning { animation: spin 0.8s linear infinite; }

    /* ===== SEARCH ===== */
    .search-box {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      color: #ccc;
      padding: 6px 14px;
      border-radius: 10px;
      font-size: 0.78rem;
      width: 240px;
      outline: none;
      transition: border-color 0.15s, background 0.15s;
      font-family: var(--font-stack);
    }

    .search-box:focus { border-color: var(--accent); background: #1e1e1e; }
    .search-box::placeholder { color: #444; }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #121212; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    /* ===== FOOTER ===== */
    .footer {
      text-align: center;
      padding: 1.5rem;
      color: #333;
      font-size: 0.7rem;
      border-top: 1px solid #1a1a1a;
      margin-top: 1rem;
    }

    /* ===== CARD ACTION BUTTONS ===== */
    .card-actions {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      margin-left: auto;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .card:hover .card-actions { opacity: 1; }

    /* Always show if bookmarked */
    .card-actions:has(.bookmarked) { opacity: 1; }

    .card-action-btn {
      background: none;
      border: none;
      color: #555;
      cursor: pointer;
      font-size: 0.82rem;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.15s;
      line-height: 1;
    }

    .card-action-btn:hover { color: var(--accent); }
    .card-action-btn.bookmark-star { color: #444; font-size: 0.95rem; }
    .card-action-btn.bookmark-star:hover { color: #ffd700; }
    .card-action-btn.bookmark-star.bookmarked { color: #ffd700; opacity: 1; }
    .card-action-btn.copied { color: #4caf50; }

    /* ===== SEARCH HIGHLIGHT ===== */
    mark {
      background: rgba(230, 0, 18, 0.3);
      color: white;
      font-weight: bold;
      border-radius: 2px;
      padding: 0 2px;
    }

    /* ===== HIGH CONTRAST MODE ===== */
    body.high-contrast {
      --bg-color: #ffffff;
      --card-bg: #f0f0f0;
      --card-border: #ccc;
      --text-main: #000000;
      --text-muted: #444;
    }

    body.high-contrast a { color: #000; }
    body.high-contrast a:hover { color: var(--accent); }
    body.high-contrast .header { background: rgba(240, 240, 240, 0.97); border-bottom-color: #ddd; }
    body.high-contrast .header h1 { color: #000; }
    body.high-contrast .card { background: #fff; border-left-color: #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    body.high-contrast .card:hover { background: #fafafa; border-left-color: var(--accent); }
    body.high-contrast .card-title a { color: #111; }
    body.high-contrast .card-source { color: #666; }
    body.high-contrast .filter-chip { background: transparent; color: #555; border-color: #ccc; }
    body.high-contrast .filter-chip.active { background: var(--accent); color: #fff; }
    body.high-contrast .toolbar { background: transparent; }
    body.high-contrast .search-box { background: #fff; border-color: #ccc; color: #000; }
    body.high-contrast .hype-btn { background: transparent; color: #555; border-color: #ccc; }
    body.high-contrast .favorites-btn { color: #333; border-color: #ccc; }
    body.high-contrast .results-box { background: linear-gradient(135deg, #f5f5f5, #eee); }
    body.high-contrast .result-item { border-bottom-color: #ddd; }
    body.high-contrast .result-item:hover { background: #e8e8e8; }
    body.high-contrast .footer { color: #888; border-top-color: #ddd; }
    body.high-contrast mark { background: rgba(230, 0, 18, 0.2); color: #000; }

    .contrast-toggle {
      background: none;
      border: 1px solid #444;
      color: var(--text-muted);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .contrast-toggle:hover { border-color: var(--accent); color: var(--accent); }
    body.high-contrast .contrast-toggle { border-color: #999; color: #333; }

    /* ===== MODAL ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .modal-overlay.visible { display: flex; }

    .modal-box {
      background: var(--card-bg);
      border: 2px solid var(--accent);
      border-radius: 14px;
      padding: 1.5rem;
      max-width: 800px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.4rem;
      cursor: pointer;
      transition: color 0.15s;
    }

    .modal-close:hover { color: var(--accent); }

    body.high-contrast .modal-box { background: #f5f5f5; }
    body.high-contrast .modal-overlay { background: rgba(0,0,0,0.4); }

    /* ===== ARCHIVE COLUMN ===== */
    .column.archive-hidden { display: none; }

    .grid-container.two-col {
      grid-template-columns: 1.2fr 0.8fr;
    }

    @media (max-width: 699px) {
      .grid-container.two-col { grid-template-columns: 1fr; }
    }

    .footer .cache-btn {
      margin-top: 0.5rem;
      background: #333;
      color: #999;
      border: 1px solid #444;
      padding: 4px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.72rem;
      transition: all 0.15s;
    }

    .footer .cache-btn:hover { border-color: var(--accent); color: var(--accent); }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="header-branding">
      <h1><span class="accent">BR√ÖSS!</span> STUDIO RADAR</h1>
      <div class="subtitle">Nintendo & Videospill Podcast ‚Äî Live Nyhetsdashbord</div>
    </div>
    <div id="status-bar-container">
      <div class="status-bar" id="statusBar" aria-live="polite">
        <span class="spinner"></span> Henter nyheter fra 33 kilder...
      </div>
    </div>
    <button class="contrast-toggle" onclick="toggleHighContrast()" title="Bytt mellom m√∏rk og lys modus">üåì Kontrast</button>
  </header>

  <!-- TOOLBAR: search, refresh -->
  <div class="toolbar" id="statusRow" style="display:none;">
    <input type="text" class="search-box" id="searchBox" placeholder="üîç S√∏k i nyheter..." oninput="onSearchInput()">
    <span class="last-updated" id="lastUpdated"></span>
    <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">‚Üª Oppdater n√•</button>
  </div>

  <!-- FILTER BAR -->
  <div class="filter-bar" id="filterBar" style="display:none;">
    <div class="filter-group">
      <span class="filter-group-label">Kilder:</span>
      <button class="filter-chip active" data-filter-type="source-group" data-value="all" onclick="toggleSourceGroupFilter(this)">Alle</button>
      <button class="filter-chip" data-filter-type="source-group" data-value="int" onclick="toggleSourceGroupFilter(this)">üåç Internasjonale</button>
      <button class="filter-chip" data-filter-type="source-group" data-value="no" onclick="toggleSourceGroupFilter(this)">üá≥üá¥ Norske</button>
      <button class="filter-chip" data-filter-type="source-group" data-value="niche" onclick="toggleSourceGroupFilter(this)">üß© Nisje</button>
    </div>
    <div class="filter-divider"></div>
    <div class="filter-group">
      <span class="filter-group-label">Kategori:</span>
      <button class="filter-chip active" data-filter-type="category" data-value="all" onclick="toggleCategoryFilter(this)">Alle</button>
      <button class="filter-chip" data-filter-type="category" data-value="rykter" onclick="toggleCategoryFilter(this)">üî• Rykter</button>
      <button class="filter-chip" data-filter-type="category" data-value="anmeldelse" onclick="toggleCategoryFilter(this)">‚≠ê Anmeldelser</button>
      <button class="filter-chip" data-filter-type="category" data-value="utgivelse" onclick="toggleCategoryFilter(this)">üéÆ Utgivelser</button>
      <button class="filter-chip" data-filter-type="category" data-value="hardware" onclick="toggleCategoryFilter(this)">üîß Hardware</button>
      <button class="filter-chip" data-filter-type="category" data-value="bransje" onclick="toggleCategoryFilter(this)">üìä Bransje</button>
      <button class="filter-chip" data-filter-type="category" data-value="salg" onclick="toggleCategoryFilter(this)">üí∞ Salg</button>
    </div>
    <div class="filter-divider"></div>
    <div class="filter-group">
      <button class="filter-chip" id="archiveToggleChip" onclick="toggleArchiveColumn()">üìÅ Vis eldre saker (arkiv)</button>
    </div>
  </div>

  <!-- THREE-COLUMN GRID -->
  <div class="grid-container two-col" id="gridContainer" aria-live="polite">
    <div class="column" id="colToday">
      <div class="column-header">
        üî¥ Dagens <small>(siste 24t)</small>
        <span class="count" id="countToday">0</span>
      </div>
      <div class="card-list" id="listToday"></div>
    </div>
    <div class="column" id="colWeek">
      <div class="column-header">
        üì∞ Ukens <small>(siste 7 dager)</small>
        <span class="count" id="countWeek">0</span>
      </div>
      <div class="card-list" id="listWeek"></div>
    </div>
    <div class="column archive-hidden" id="colMonth">
      <div class="column-header">
        üìÖ M√•nedens <small>(siste 30 dager)</small>
        <span class="count" id="countMonth">0</span>
      </div>
      <div class="card-list" id="listMonth"></div>
    </div>
  </div>

  <!-- FAVORITES BUTTON -->
  <div class="favorites-section">
    <button class="favorites-btn" id="favoritesBtn" onclick="toggleFavoritesPanel()">
      ‚≠ê Vis Manus / Favoritter <span class="fav-count" id="favCount">0</span>
    </button>
  </div>

  <!-- FAVORITES PANEL -->
  <div class="results-container" id="resultsContainer">
    <div class="results-box">
      <div class="results-header">‚≠ê Manus ‚Äî Lagrede Saker ‚≠ê</div>
      <div class="favorites-toolbar">
        <button onclick="copyAllFavorites()" title="Kopier alle til utklippstavlen">üìã Kopier alle</button>
        <button onclick="clearAllFavorites()" class="remove" title="Fjern alle favoritter">üóëÔ∏è T√∏m manus</button>
      </div>
      <div id="resultsList"></div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    BR√ÖSS! Studio Radar &mdash; Gratis verkt√∏y for podcast-produksjon &mdash; Drevet av RSS &amp; Vanilla JS
    <br>
    <button class="cache-btn" onclick="openSettingsModal()" title="√Öpne innstillinger">‚öôÔ∏è Innstillinger / Kildestatus</button>
    <button class="cache-btn" onclick="clearCache()" title="Sletter alle lagrede nyheter fra nettleseren">üóëÔ∏è T√∏m lokal cache</button>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-overlay" id="settingsModal" onclick="closeSettingsModal(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span>‚öôÔ∏è Kildestatus</span>
        <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
      </div>
      <div class="feed-status-grid" id="feedStatusGrid"></div>
    </div>
  </div>

<script>
/* ====================================================================
   BR√ÖSS! STUDIO RADAR ‚Äî Full SPA Logic
   ==================================================================== */

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RSS_FEEDS = [
  // üî¥ Internasjonale (13)
  { url: 'https://www.nintendolife.com/feeds/latest', name: 'Nintendo Life', group: 'int' },
  { url: 'https://nintendoeverything.com/feed/', name: 'Nintendo Everything', group: 'int' },
  { url: 'https://www.videogameschronicle.com/feed/', name: 'VGC', group: 'int' },
  { url: 'https://www.eurogamer.net/feed/nintendo', name: 'Eurogamer', group: 'int' },
  { url: 'https://www.ign.com/rss/articles/nintendo', name: 'IGN', group: 'int' },
  { url: 'https://www.gematsu.com/feed', name: 'Gematsu', group: 'int' },
  { url: 'https://gonintendo.com/feed', name: 'GoNintendo', group: 'int' },
  { url: 'https://kotaku.com/rss', name: 'Kotaku', group: 'int' },
  { url: 'https://www.gamesindustry.biz/rss', name: 'GamesIndustry.biz', group: 'int' },
  { url: 'https://www.polygon.com/rss/index.xml', name: 'Polygon', group: 'int' },
  { url: 'https://mynintendonews.com/feed/', name: 'My Nintendo News', group: 'int' },
  { url: 'https://www.nintendoinsider.com/feed/', name: 'Nintendo Insider', group: 'int' },
  { url: 'https://www.gamesradar.com/rss/', name: 'GamesRadar+', group: 'int' },
  // üá≥üá¥ Norske (5)
  { url: 'https://www.pressfire.no/rss', name: 'Pressfire.no', group: 'no' },
  { url: 'https://www.gamer.no/feeds/general.xml', name: 'Gamer.no', group: 'no' },
  { url: 'https://www.gamereactor.no/rss/rss.php', name: 'Gamereactor NO', group: 'no' },
  { url: 'https://itavisen.no/kategori/spill/feed/', name: 'ITavisen', group: 'no' },
  { url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCv_9_p_pS06Yv_3_n4f47pA', name: 'Level Up Norge', group: 'no' },
  // üß© Nisje-kilder (15)
  { url: 'https://nintendo.com/whatsnew/rss', name: 'Nintendo Offisiell', group: 'niche' },
  { url: 'https://www.destructoid.com/feed/', name: 'Destructoid', group: 'niche' },
  { url: 'https://www.siliconera.com/feed/', name: 'Siliconera', group: 'niche' },
  { url: 'https://www.theverge.com/games/rss/index.xml', name: 'The Verge', group: 'niche' },
  { url: 'https://www.pocketgamer.com/rss/', name: 'Pocket Gamer', group: 'niche' },
  { url: 'https://nintendosoup.com/feed/', name: 'NintendoSoup', group: 'niche' },
  { url: 'https://www.famitsu.com/feed/', name: 'Famitsu', group: 'niche' },
  { url: 'https://www.reddit.com/r/NintendoSwitch/.rss', name: 'r/NintendoSwitch', group: 'niche' },
  { url: 'https://www.reddit.com/r/nintendo/.rss', name: 'r/nintendo', group: 'niche' },
  { url: 'https://www.reddit.com/r/NintendoSwitch2/.rss', name: 'r/NintendoSwitch2', group: 'niche' },
  { url: 'https://www.reddit.com/r/casualnintendo/.rss', name: 'r/casualnintendo', group: 'niche' },
  { url: 'https://www.reddit.com/r/Zelda/.rss', name: 'r/Zelda', group: 'niche' },
  { url: 'https://www.reddit.com/r/pokemon/.rss', name: 'r/pokemon', group: 'niche' },
  { url: 'https://www.reddit.com/r/SmashBrosUltimate/.rss', name: 'r/SmashBrosUltimate', group: 'niche' },
  { url: 'https://www.reddit.com/r/Switch/.rss', name: 'r/Switch', group: 'niche' },
];

const RSS2JSON_BASE = 'https://api.rss2json.com/v1/api.json?rss_url=';

// Hype keywords: [pattern, scoreDelta]
const HYPE_POSITIVE = [
  [/switch\s*2/i, 3],
  [/zelda/i, 2],
  [/mario/i, 2],
  [/direct/i, 2],
  [/leak/i, 2],
  [/review/i, 1],
  [/metroid/i, 2],
  [/smash/i, 1],
  [/pokemon|pok√©mon/i, 2],
  [/exclusive/i, 1],
  [/announce|reveal/i, 1],
  [/goty|game of the year/i, 1],
];

const HYPE_NEGATIVE = [
  [/update/i, -1],
  [/patch/i, -1],
  [/maintenance/i, -2],
  [/server/i, -1],
];

// Article category detection rules: [regex, category]
const CATEGORY_RULES = [
  [/leak|rumou?r|reportedly|insider|datamin/i, 'rykter'],
  [/review|\d+\/10|score[ds]?|rated|verdict/i, 'anmeldelse'],
  [/release|launch|coming|out now|available now|trailer|announce|reveal/i, 'utgivelse'],
  [/switch\s*2|hardware|console|specs|teardown|controller|joy.?con/i, 'hardware'],
  [/sale|deal|discount|price|offer|eshop sale|free-to|free to play/i, 'salg'],
  [/million|billion|revenue|NPD|chart|sales figures|financial|stock|shares|market/i, 'bransje'],
];

// Category display info
const CATEGORY_INFO = {
  nyheter:    { label: 'üì∞ Nyheter',    css: 'cat-nyheter' },
  rykter:     { label: 'üî• Rykter',     css: 'cat-rykter' },
  anmeldelse: { label: '‚≠ê Anmeldelse', css: 'cat-anmeldelse' },
  utgivelse:  { label: 'üéÆ Utgivelse',  css: 'cat-utgivelse' },
  hardware:   { label: 'üîß Hardware',   css: 'cat-hardware' },
  bransje:    { label: 'üìä Bransje',    css: 'cat-bransje' },
  salg:       { label: 'üí∞ Salg',       css: 'cat-salg' },
  video:      { label: 'üé¨ Video',      css: 'cat-video' },
};

// Jaccard duplicate threshold
const JACCARD_THRESHOLD = 0.45;

// localStorage key
const STORAGE_KEY = 'brass_radar_articles';
const STORAGE_MAX_AGE_DAYS = 30;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allArticles = []; // master array of article objects
let feedStatus = {};  // { feedName: { status: 'ok'|'fail'|'loading', count: 0 } }
let activeSourceGroup = 'all'; // 'all' | 'int' | 'no' | 'niche'
let activeCategory = 'all';    // 'all' | 'rykter' | 'anmeldelse' | etc.
let searchQuery = '';           // current search text
let showMoreState = { today: false, week: false, month: false };
let archiveVisible = false;
const INITIAL_SHOW_COUNT = 8;
const BOOKMARKS_KEY = 'brass_radar_bookmarks';

// ‚îÄ‚îÄ LOCAL STORAGE (CACHE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Save articles to localStorage (strips hidden flag, re-applied on load) */
function saveToCache(articles) {
  try {
    const toStore = articles.map(a => ({
      title: a.title,
      link: a.link,
      pubDate: a.pubDate,
      source: a.source,
      sourceGroup: a.sourceGroup,
      category: a.category,
      autoHype: a.autoHype,
      manualHype: a.manualHype,
      thumbnail: a.thumbnail || '',
    }));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toStore));
  } catch (e) {
    console.warn('Kunne ikke lagre til localStorage:', e);
  }
}

/** Load cached articles from localStorage */
function loadFromCache() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];
    return parsed.map(a => ({
      id: uid(),
      title: a.title || '',
      link: a.link || '#',
      pubDate: a.pubDate || '',
      source: a.source || 'Ukjent',
      sourceGroup: a.sourceGroup || 'int',
      category: a.category || detectCategory(a.title || '', a.source || ''),
      autoHype: a.autoHype || 3,
      manualHype: a.manualHype ?? null,
      thumbnail: a.thumbnail || '',
      hidden: false,
    }));
  } catch (e) {
    console.warn('Kunne ikke lese fra localStorage:', e);
    return [];
  }
}

/** Remove articles older than STORAGE_MAX_AGE_DAYS */
function purgeOldArticles(articles) {
  const cutoff = Date.now() - (STORAGE_MAX_AGE_DAYS * 24 * 60 * 60 * 1000);
  return articles.filter(a => {
    const pub = new Date(a.pubDate).getTime();
    if (!pub || isNaN(pub)) return true; // keep if no date
    return pub >= cutoff;
  });
}

/** Merge new RSS articles with cached ones (dedupe by link) */
function mergeWithCache(freshArticles, cachedArticles) {
  const seenLinks = new Set();
  const merged = [];

  // Fresh articles take priority
  for (const art of freshArticles) {
    const key = art.link.replace(/\/$/, '').toLowerCase();
    if (!seenLinks.has(key)) {
      seenLinks.add(key);
      // Preserve manual hype from cache if same article
      const cached = cachedArticles.find(c => c.link.replace(/\/$/, '').toLowerCase() === key);
      if (cached && cached.manualHype !== null) {
        art.manualHype = cached.manualHype;
      }
      merged.push(art);
    }
  }

  // Add cached articles that are NOT in fresh results
  for (const art of cachedArticles) {
    const key = art.link.replace(/\/$/, '').toLowerCase();
    if (!seenLinks.has(key)) {
      seenLinks.add(key);
      merged.push(art);
    }
  }

  return merged;
}

/** Clear the cache */
function clearCache() {
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

// ‚îÄ‚îÄ UTILITY FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Clamp number between min and max */
function clamp(val, min, max) {
  return Math.max(min, Math.min(max, val));
}

/** Calculate auto Hype Score for an article title */
function calcAutoHype(title) {
  let score = 3;
  for (const [regex, delta] of HYPE_POSITIVE) {
    if (regex.test(title)) score += delta;
  }
  for (const [regex, delta] of HYPE_NEGATIVE) {
    if (regex.test(title)) score += delta; // delta is already negative
  }
  return clamp(score, 1, 10);
}

/** Detect article category from title */
function detectCategory(title, source) {
  // YouTube sources are always 'video'
  if (source === 'Level Up Norge') return 'video';
  for (const [regex, cat] of CATEGORY_RULES) {
    if (regex.test(title)) return cat;
  }
  return 'nyheter'; // default
}

/** Get the CSS class for a hype score badge */
function hypeClass(score) {
  if (score >= 8) return 'hype-fire';
  if (score >= 6) return 'hype-high';
  if (score >= 4) return 'hype-med';
  return 'hype-low';
}

/** Normalize a title into a set of unique lowercase words (for Jaccard) */
function wordSet(title) {
  const words = title
    .toLowerCase()
    .replace(/[^a-z√¶√∏√•0-9\s]/gi, '')
    .split(/\s+/)
    .filter(w => w.length > 2); // ignore very short words
  return new Set(words);
}

/** Jaccard similarity between two word sets */
function jaccard(setA, setB) {
  if (setA.size === 0 && setB.size === 0) return 0;
  let intersection = 0;
  for (const w of setA) {
    if (setB.has(w)) intersection++;
  }
  const union = setA.size + setB.size - intersection;
  return union === 0 ? 0 : intersection / union;
}

/** Time category: 'today' | 'week' | 'month' | 'old' */
function timeCategory(pubDate) {
  const now = Date.now();
  const pub = new Date(pubDate).getTime();

  // If date is invalid/missing, put in 'month' as fallback so it still shows up
  if (!pub || isNaN(pub)) return 'month';

  const diffMs = now - pub;
  const diffHours = diffMs / (1000 * 60 * 60);

  // Future dates (can happen with timezone issues) ‚Üí treat as today
  if (diffHours < 0) return 'today';
  if (diffHours <= 24) return 'today';
  if (diffHours <= 24 * 7) return 'week';
  if (diffHours <= 24 * 30) return 'month';
  return 'old';
}

/** Format a date nicely */
function formatDate(dateStr) {
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('nb-NO', {
      day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
    });
  } catch {
    return dateStr;
  }
}

/** Generate a unique ID */
let _idCounter = 0;
function uid() { return 'art_' + (++_idCounter); }

/** Sanitize a URL ‚Äî only allow http/https links */
function sanitizeUrl(url) {
  if (!url) return '#';
  try {
    const parsed = new URL(url);
    if (parsed.protocol === 'http:' || parsed.protocol === 'https:') return url;
    return '#';
  } catch {
    return '#';
  }
}

// ‚îÄ‚îÄ RSS FETCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchFeed(feed) {
  const url = RSS2JSON_BASE + encodeURIComponent(feed.url);
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data.status !== 'ok') throw new Error(data.message || 'RSS Parse Error');

    return (data.items || []).map(item => {
      // Try to extract thumbnail from enclosure or thumbnail field
      let thumb = '';
      if (item.enclosure && item.enclosure.link) thumb = item.enclosure.link;
      else if (item.thumbnail) thumb = item.thumbnail;

      return {
        id: uid(),
        title: (item.title || '').trim(),
        link: item.link || '#',
        pubDate: item.pubDate || '',
        source: feed.name,
        sourceGroup: feed.group,
        category: detectCategory(item.title || '', feed.name),
        autoHype: calcAutoHype(item.title || ''),
        manualHype: null,
        thumbnail: thumb,
        hidden: false,
      };
    });
  } catch (err) {
    console.warn(`Feil ved henting av ${feed.name}:`, err);
    return [];
  }
}

/** Throttled fetch: sequential with 300ms delay to avoid rss2json rate limits */
async function fetchAllFeeds() {
  const allResults = [];
  feedStatus = {};

  // Initialize all as loading
  for (const feed of RSS_FEEDS) {
    feedStatus[feed.name] = { status: 'loading', count: 0 };
  }
  renderFeedStatus();

  // Fetch in small batches of 4 with delay between batches
  const BATCH_SIZE = 4;
  const BATCH_DELAY = 400; // ms between batches

  for (let i = 0; i < RSS_FEEDS.length; i += BATCH_SIZE) {
    const batch = RSS_FEEDS.slice(i, i + BATCH_SIZE);
    const batchResults = await Promise.all(batch.map(async (feed) => {
      try {
        const items = await fetchFeed(feed);
        feedStatus[feed.name] = { status: 'ok', count: items.length };
        renderFeedStatus();
        return items;
      } catch (err) {
        feedStatus[feed.name] = { status: 'fail', count: 0 };
        renderFeedStatus();
        return [];
      }
    }));
    allResults.push(...batchResults.flat());

    // Delay before next batch (skip after last batch)
    if (i + BATCH_SIZE < RSS_FEEDS.length) {
      await new Promise(r => setTimeout(r, BATCH_DELAY));
    }
  }

  return allResults;
}

/** Render the feed status indicators */
function renderFeedStatus() {
  const grid = document.getElementById('feedStatusGrid');
  if (!grid) return;
  grid.innerHTML = RSS_FEEDS.map(feed => {
    const s = feedStatus[feed.name] || { status: 'loading', count: 0 };
    const statusClass = ['ok', 'fail', 'loading'].includes(s.status) ? s.status : 'loading';
    const statusText = s.status === 'ok' ? s.count + ' saker' : s.status === 'fail' ? 'feilet' : '...';
    return `<div class="feed-status-item">
      <span class="feed-dot ${statusClass}"></span>
      <span>${escapeHtml(feed.name)}</span>
      <span class="feed-count">${escapeHtml(statusText)}</span>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ DUPLICATE REMOVAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function removeDuplicates(articles) {
  // Precompute word sets
  const sets = articles.map(a => ({ article: a, ws: wordSet(a.title) }));

  // Mark duplicates
  for (let i = 0; i < sets.length; i++) {
    if (sets[i].article.hidden) continue;
    for (let j = i + 1; j < sets.length; j++) {
      if (sets[j].article.hidden) continue;
      // Only check across different sources
      if (sets[i].article.source === sets[j].article.source) continue;

      const sim = jaccard(sets[i].ws, sets[j].ws);
      if (sim >= JACCARD_THRESHOLD) {
        // Keep the one with highest hype, or the newest
        const scoreI = sets[i].article.autoHype;
        const scoreJ = sets[j].article.autoHype;
        if (scoreI > scoreJ) {
          sets[j].article.hidden = true;
        } else if (scoreJ > scoreI) {
          sets[i].article.hidden = true;
        } else {
          // Same score ‚Üí keep newest
          const dateI = new Date(sets[i].article.pubDate).getTime() || 0;
          const dateJ = new Date(sets[j].article.pubDate).getTime() || 0;
          if (dateI >= dateJ) {
            sets[j].article.hidden = true;
          } else {
            sets[i].article.hidden = true;
          }
        }
      }
    }
  }

  return articles;
}

// ‚îÄ‚îÄ BOOKMARKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function loadBookmarks() {
  try {
    const raw = localStorage.getItem(BOOKMARKS_KEY);
    return raw ? new Set(JSON.parse(raw)) : new Set();
  } catch { return new Set(); }
}

function saveBookmarks(set) {
  localStorage.setItem(BOOKMARKS_KEY, JSON.stringify([...set]));
}

function toggleBookmark(articleLink) {
  const bookmarks = loadBookmarks();
  const key = articleLink.replace(/\/$/, '').toLowerCase();
  if (bookmarks.has(key)) {
    bookmarks.delete(key);
  } else {
    bookmarks.add(key);
  }
  saveBookmarks(bookmarks);
  // Update button in-place
  const btn = document.querySelector(`[data-bookmark-link="${CSS.escape(key)}"]`);
  if (btn) {
    const isFav = bookmarks.has(key);
    btn.classList.toggle('bookmarked', isFav);
    btn.textContent = isFav ? '‚òÖ' : '‚òÜ';
    btn.title = isFav ? 'Fjern fra manus' : 'Lagre til manus';
  }
  updateFavCount();
  // If favorites panel is open, refresh it
  const container = document.getElementById('resultsContainer');
  if (container.classList.contains('visible')) renderFavorites();
}

function isBookmarked(link) {
  return loadBookmarks().has(link.replace(/\/$/, '').toLowerCase());
}

// ‚îÄ‚îÄ COPY TO CLIPBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function copyToClipboard(title, link, triggerEl) {
  const text = `${title} - ${link}`;
  try {
    await navigator.clipboard.writeText(text);
    if (triggerEl) {
      triggerEl.classList.add('copied');
      triggerEl.textContent = '‚úì';
      setTimeout(() => {
        triggerEl.classList.remove('copied');
        triggerEl.textContent = 'üìã';
      }, 1500);
    }
  } catch {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
}

// ‚îÄ‚îÄ FAVICON HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getFaviconUrl(source) {
  const domainMap = {
    'Nintendo Life': 'nintendolife.com',
    'Nintendo Everything': 'nintendoeverything.com',
    'VGC': 'videogameschronicle.com',
    'Eurogamer': 'eurogamer.net',
    'IGN': 'ign.com',
    'Gematsu': 'gematsu.com',
    'GoNintendo': 'gonintendo.com',
    'Kotaku': 'kotaku.com',
    'GamesIndustry.biz': 'gamesindustry.biz',
    'Polygon': 'polygon.com',
    'My Nintendo News': 'mynintendonews.com',
    'Nintendo Insider': 'nintendoinsider.com',
    'GamesRadar+': 'gamesradar.com',
    'Pressfire.no': 'pressfire.no',
    'Gamer.no': 'gamer.no',
    'Gamereactor NO': 'gamereactor.no',
    'ITavisen': 'itavisen.no',
    'Level Up Norge': 'youtube.com',
    'Nintendo Offisiell': 'nintendo.com',
    'Destructoid': 'destructoid.com',
    'Siliconera': 'siliconera.com',
    'The Verge': 'theverge.com',
    'Pocket Gamer': 'pocketgamer.com',
    'NintendoSoup': 'nintendosoup.com',
    'Famitsu': 'famitsu.com',
    'r/NintendoSwitch': 'reddit.com',
    'r/nintendo': 'reddit.com',
    'r/NintendoSwitch2': 'reddit.com',
    'r/casualnintendo': 'reddit.com',
    'r/Zelda': 'reddit.com',
    'r/pokemon': 'reddit.com',
    'r/SmashBrosUltimate': 'reddit.com',
    'r/Switch': 'reddit.com',
  };
  const domain = domainMap[source] || '';
  if (!domain) return '';
  return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
}

// ‚îÄ‚îÄ SEARCH HIGHLIGHTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function highlightText(text, query) {
  if (!query || !query.trim()) return escapeHtml(text);
  const escaped = escapeHtml(text);
  const q = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${q})`, 'gi');
  return escaped.replace(regex, '<mark>$1</mark>');
}

// ‚îÄ‚îÄ RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getEffectiveHype(article) {
  return article.manualHype !== null ? article.manualHype : article.autoHype;
}

function renderCard(article) {
  const score = getEffectiveHype(article);
  const badgeClass = hypeClass(score);
  const catInfo = CATEGORY_INFO[article.category] || CATEGORY_INFO.nyheter;
  const safeLink = sanitizeUrl(article.link);
  const fireClass = score >= 8 ? ' fire-card' : '';
  const faviconUrl = getFaviconUrl(article.source);
  const faviconImg = faviconUrl ? `<img class="favicon" src="${faviconUrl}" alt="" loading="lazy">` : '';
  const bookmarked = isBookmarked(article.link);
  const bookmarkKey = article.link.replace(/\/$/, '').toLowerCase();
  const titleHtml = highlightText(article.title, searchQuery);
  const thumbHtml = article.thumbnail ? `<img class="card-thumbnail" src="${sanitizeUrl(article.thumbnail)}" alt="" loading="lazy">` : '';

  return `
    <div class="card${fireClass}" id="${escapeAttr(article.id)}" data-article-id="${escapeAttr(article.id)}">
      <div class="card-body">
        <div class="card-title"><a href="${escapeAttr(safeLink)}" target="_blank" rel="noopener noreferrer">${titleHtml}</a></div>
        <div class="card-meta">
          <span class="card-source">${faviconImg}${escapeHtml(article.source)}</span>
          <span class="card-category ${catInfo.css}">${catInfo.label}</span>
          <span class="card-date">${formatDate(article.pubDate)}</span>
        </div>
        <div class="hype-section">
          <span class="hype-label">Hype</span>
          <button class="hype-btn" data-action="hype-down" data-id="${escapeAttr(article.id)}" aria-label="Senk hype">&minus;</button>
          <span class="hype-badge ${badgeClass}" id="badge_${escapeAttr(article.id)}">${score}</span>
          <button class="hype-btn" data-action="hype-up" data-id="${escapeAttr(article.id)}" aria-label="√òk hype">+</button>
          <div class="card-actions">
            <button class="card-action-btn bookmark-star${bookmarked ? ' bookmarked' : ''}" data-bookmark-link="${escapeAttr(bookmarkKey)}" data-action="bookmark" data-link="${escapeAttr(safeLink)}" title="${bookmarked ? 'Fjern fra manus' : 'Lagre til manus'}" aria-label="Bokmerke">${bookmarked ? '‚òÖ' : '‚òÜ'}</button>
            <button class="card-action-btn" data-action="copy" data-id="${escapeAttr(article.id)}" title="Kopier til manus" aria-label="Kopier">üìã</button>
          </div>
        </div>
      </div>
      ${thumbHtml}
    </div>`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

/** Escape a string for safe use in HTML attributes */
function escapeAttr(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

/** Check if an article passes the active filters */
function passesFilters(art) {
  // Source group filter
  if (activeSourceGroup !== 'all' && art.sourceGroup !== activeSourceGroup) return false;
  // Category filter
  if (activeCategory !== 'all' && art.category !== activeCategory) return false;
  // Search filter
  if (searchQuery.trim()) {
    const q = searchQuery.toLowerCase();
    const inTitle = art.title.toLowerCase().includes(q);
    const inSource = art.source.toLowerCase().includes(q);
    if (!inTitle && !inSource) return false;
  }
  return true;
}

function renderColumnList(articles, listId, emptyMsg, timeBucket) {
  const listEl = document.getElementById(listId);
  if (articles.length === 0) {
    listEl.innerHTML = `<div class="empty-state">${emptyMsg}</div>`;
    return;
  }

  const limit = showMoreState[timeBucket] ? articles.length : INITIAL_SHOW_COUNT;
  const visible = articles.slice(0, limit);
  let html = visible.map(renderCard).join('');

  if (articles.length > INITIAL_SHOW_COUNT) {
    if (!showMoreState[timeBucket]) {
      html += `<button class="show-more-btn" data-action="show-more" data-bucket="${escapeAttr(timeBucket)}">Vis ${articles.length - INITIAL_SHOW_COUNT} flere ‚ñº</button>`;
    } else {
      html += `<button class="show-more-btn" data-action="show-more" data-bucket="${escapeAttr(timeBucket)}">Vis f√¶rre ‚ñ≤</button>`;
    }
  }

  listEl.innerHTML = html;
}

function toggleShowMore(bucket) {
  showMoreState[bucket] = !showMoreState[bucket];
  renderColumns();
}

function renderColumns() {
  const todayList = [];
  const weekList = [];
  const monthList = [];

  for (const art of allArticles) {
    if (art.hidden) continue;
    if (!passesFilters(art)) continue;
    const cat = timeCategory(art.pubDate);
    if (cat === 'today') todayList.push(art);
    else if (cat === 'week') weekList.push(art);
    else if (cat === 'month') monthList.push(art);
    // 'old' articles are silently omitted
  }

  // Sort each bucket: newest first, then hype as tiebreaker
  const sorter = (a, b) => {
    const dateDiff = new Date(b.pubDate) - new Date(a.pubDate);
    if (dateDiff !== 0) return dateDiff;
    return getEffectiveHype(b) - getEffectiveHype(a);
  };

  todayList.sort(sorter);
  weekList.sort(sorter);
  monthList.sort(sorter);

  renderColumnList(todayList, 'listToday', 'Ingen nyheter siste 24 timer', 'today');
  renderColumnList(weekList, 'listWeek', 'Ingen nyheter denne uken', 'week');
  renderColumnList(monthList, 'listMonth', 'Ingen nyheter denne m√•neden', 'month');

  document.getElementById('countToday').textContent = todayList.length;
  document.getElementById('countWeek').textContent = weekList.length;
  document.getElementById('countMonth').textContent = monthList.length;
}

// ‚îÄ‚îÄ MANUAL HYPE ADJUSTMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function adjustHype(articleId, delta) {
  const art = allArticles.find(a => a.id === articleId);
  if (!art) return;

  const current = getEffectiveHype(art);
  const newScore = clamp(current + delta, 1, 10);
  art.manualHype = newScore;

  // Persist to cache
  saveToCache(allArticles);

  // Update badge in-place (no full re-render)
  const badge = document.getElementById('badge_' + articleId);
  if (badge) {
    badge.textContent = newScore;
    badge.className = 'hype-badge ' + hypeClass(newScore);
  }
}

// ‚îÄ‚îÄ FILTERING & SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleSourceGroupFilter(btn) {
  const value = btn.dataset.value;
  activeSourceGroup = value;
  // Update active state on chips
  document.querySelectorAll('[data-filter-type="source-group"]').forEach(el => {
    el.classList.toggle('active', el.dataset.value === value);
  });
  showMoreState = { today: false, week: false, month: false };
  renderColumns();
}

function toggleCategoryFilter(btn) {
  const value = btn.dataset.value;
  activeCategory = value;
  document.querySelectorAll('[data-filter-type="category"]').forEach(el => {
    el.classList.toggle('active', el.dataset.value === value);
  });
  showMoreState = { today: false, week: false, month: false };
  renderColumns();
}

let searchDebounce = null;
function onSearchInput() {
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(() => {
    searchQuery = document.getElementById('searchBox').value;
    showMoreState = { today: false, week: false, month: false };
    renderColumns();
  }, 250);
}

function toggleFeedPanel() {
  openSettingsModal();
}

function openSettingsModal() {
  document.getElementById('settingsModal').classList.add('visible');
}

function closeSettingsModal(e) {
  if (e && e.target !== e.currentTarget) return;
  document.getElementById('settingsModal').classList.remove('visible');
}

// ‚îÄ‚îÄ HIGH CONTRAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleHighContrast() {
  document.body.classList.toggle('high-contrast');
  const isHC = document.body.classList.contains('high-contrast');
  localStorage.setItem('brass_high_contrast', isHC ? '1' : '0');
}

function loadHighContrastPref() {
  if (localStorage.getItem('brass_high_contrast') === '1') {
    document.body.classList.add('high-contrast');
  }
}

loadHighContrastPref();

// ‚îÄ‚îÄ ARCHIVE TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleArchiveColumn() {
  archiveVisible = !archiveVisible;
  const col = document.getElementById('colMonth');
  const grid = document.getElementById('gridContainer');
  const chip = document.getElementById('archiveToggleChip');

  col.classList.toggle('archive-hidden', !archiveVisible);
  grid.classList.toggle('two-col', !archiveVisible);

  chip.classList.toggle('active', archiveVisible);
  chip.textContent = archiveVisible ? 'üìÅ Skjul arkiv' : 'üìÅ Vis eldre saker (arkiv)';
}

async function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  btn.disabled = true;
  await init();
  btn.classList.remove('spinning');
  btn.disabled = false;
}

// ‚îÄ‚îÄ FAVORITES PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateFavCount() {
  const count = loadBookmarks().size;
  const el = document.getElementById('favCount');
  if (el) el.textContent = count;
}

function toggleFavoritesPanel() {
  const container = document.getElementById('resultsContainer');
  const isVisible = container.classList.contains('visible');

  if (isVisible) {
    container.classList.remove('visible');
    return;
  }

  renderFavorites();
  container.classList.add('visible');

  setTimeout(() => {
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function renderFavorites() {
  const bookmarks = loadBookmarks();
  const list = document.getElementById('resultsList');

  if (bookmarks.size === 0) {
    list.innerHTML = '<div class="favorites-empty">Ingen lagrede saker enn√•.<br>Trykk ‚≠ê p√• en nyhet for √• legge den til manuset.</div>';
    updateFavCount();
    return;
  }

  // Find matching articles, sorted newest first
  const favArticles = allArticles
    .filter(a => bookmarks.has(a.link.replace(/\/$/, '').toLowerCase()))
    .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

  if (favArticles.length === 0) {
    list.innerHTML = '<div class="favorites-empty">Lagrede saker ble ikke funnet i gjeldende data.<br>De kan ha blitt eldre enn 30 dager.</div>';
    updateFavCount();
    return;
  }

  list.innerHTML = favArticles.map((art, i) => {
    const score = getEffectiveHype(art);
    const safeLink = sanitizeUrl(art.link);
    const faviconUrl = getFaviconUrl(art.source);
    const faviconImg = faviconUrl ? `<img style="width:14px;height:14px;border-radius:2px;vertical-align:middle;margin-right:4px;" src="${faviconUrl}" alt="">` : '';

    return `
      <div class="result-item" data-article-id="${escapeAttr(art.id)}">
        <div class="result-rank" style="color: #ffd700;">${i + 1}</div>
        <div class="result-info">
          <div class="result-title"><a href="${escapeAttr(safeLink)}" target="_blank" rel="noopener noreferrer">${escapeHtml(art.title)}</a></div>
          <div class="result-meta">${faviconImg}${escapeHtml(art.source)} ‚Äî ${formatDate(art.pubDate)}</div>
        </div>
        <div class="result-actions">
          <button class="result-action-btn" data-action="fav-copy" data-id="${escapeAttr(art.id)}" title="Kopier">üìã</button>
          <button class="result-action-btn remove" data-action="fav-remove" data-link="${escapeAttr(safeLink)}" title="Fjern fra manus">‚úï</button>
        </div>
      </div>`;
  }).join('');

  updateFavCount();
}

function removeFavorite(link) {
  const bookmarks = loadBookmarks();
  const key = link.replace(/\/$/, '').toLowerCase();
  bookmarks.delete(key);
  saveBookmarks(bookmarks);

  // Update star button in card if visible
  const btn = document.querySelector(`[data-bookmark-link="${CSS.escape(key)}"]`);
  if (btn) {
    btn.classList.remove('bookmarked');
    btn.textContent = '‚òÜ';
    btn.title = 'Lagre til manus';
  }

  renderFavorites();
}

async function copyAllFavorites() {
  const bookmarks = loadBookmarks();
  const favArticles = allArticles
    .filter(a => bookmarks.has(a.link.replace(/\/$/, '').toLowerCase()))
    .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

  if (favArticles.length === 0) return;

  const text = favArticles.map((art, i) =>
    `${i + 1}. ${art.title}\n   ${art.link}\n   ${art.source} ‚Äî ${formatDate(art.pubDate)}`
  ).join('\n\n');

  try {
    await navigator.clipboard.writeText(text);
    alert('Alle favoritter kopiert til utklippstavlen!');
  } catch {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('Alle favoritter kopiert!');
  }
}

function clearAllFavorites() {
  if (!confirm('Er du sikker p√• at du vil t√∏mme hele manuset?')) return;
  saveBookmarks(new Set());
  renderFavorites();
  // Update all star buttons
  document.querySelectorAll('.card-action-btn.bookmarked').forEach(btn => {
    btn.classList.remove('bookmarked');
    btn.textContent = '‚òÜ';
    btn.title = 'Lagre til manus';
  });
}

// ‚îÄ‚îÄ MAIN INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function init() {
  const statusBar = document.getElementById('statusBar');

  try {
    // 1. Load cached articles
    const cached = loadFromCache();
    const cachedCount = cached.length;

    // 2. Fetch fresh articles from RSS (throttled)
    const fresh = await fetchAllFeeds();

    // 3. Merge fresh + cached (fresh wins on duplicates, preserves manual hype)
    let merged = mergeWithCache(fresh, cached);

    // 4. Purge articles older than 30 days
    merged = purgeOldArticles(merged);

    // 5. Run duplicate detection
    allArticles = removeDuplicates(merged);

    // 6. Save merged result back to cache
    saveToCache(allArticles);

    const visibleCount = allArticles.filter(a => !a.hidden).length;
    const dupeCount = allArticles.filter(a => a.hidden).length;
    const failedFeeds = Object.values(feedStatus).filter(s => s.status === 'fail').length;

    let statusHtml = `‚úÖ <strong>${visibleCount}</strong> nyheter fra ${RSS_FEEDS.length} kilder`;
    statusHtml += ` (${fresh.length} nye + ${cachedCount} fra cache)`;
    if (dupeCount > 0) statusHtml += ` ‚Äî <span style="color:#E60012">${dupeCount} duplikater fjernet</span>`;
    if (failedFeeds > 0) statusHtml += ` ‚Äî <span style="color:#ffc107">${failedFeeds} kilder feilet</span>`;
    statusBar.innerHTML = statusHtml;

    // Show controls
    document.getElementById('statusRow').style.display = 'flex';
    document.getElementById('filterBar').style.display = 'flex';

    // Update timestamp
    const now = new Date();
    document.getElementById('lastUpdated').textContent =
      `Sist oppdatert: ${now.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' })}`;

    renderColumns();
    updateFavCount();
  } catch (err) {
    console.error('Init error:', err);
    // Fallback: try showing cached articles if RSS fails
    const cached = loadFromCache();
    if (cached.length > 0) {
      allArticles = removeDuplicates(cached);
      renderColumns();
      document.getElementById('statusRow').style.display = 'flex';
      document.getElementById('filterBar').style.display = 'flex';
      statusBar.className = 'status-bar error';
      statusBar.innerHTML = `‚ö†Ô∏è RSS-henting feilet ‚Äî viser <strong>${cached.length}</strong> lagrede nyheter fra cache`;
    } else {
      statusBar.className = 'status-bar error';
      statusBar.textContent = '‚ùå Feil ved lasting av nyheter. Sjekk internettforbindelsen.';
    }
  }
}

// ‚îÄ‚îÄ AUTO-REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AUTO_REFRESH_INTERVAL = 10 * 60 * 1000; // 10 minutes
let autoRefreshTimer = null;

function startAutoRefresh() {
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(async () => {
    console.log('Auto-refresh triggered');
    await init();
  }, AUTO_REFRESH_INTERVAL);
}

// Pause auto-refresh when tab is hidden, resume when visible
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
  } else {
    startAutoRefresh();
  }
});

// Go!
init().then(() => startAutoRefresh());

// ‚îÄ‚îÄ DELEGATED EVENT LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// All clicks on dynamically generated content are handled here instead
// of inline onclick attributes (prevents XSS from RSS content).

document.getElementById('gridContainer').addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action = btn.dataset.action;
  const id = btn.dataset.id;

  if (action === 'hype-down' || action === 'hype-up') {
    const delta = action === 'hype-up' ? 1 : -1;
    adjustHype(id, delta);
  } else if (action === 'bookmark') {
    toggleBookmark(btn.dataset.link);
  } else if (action === 'copy') {
    const art = allArticles.find(a => a.id === id);
    if (art) copyToClipboard(art.title, sanitizeUrl(art.link), btn);
  } else if (action === 'show-more') {
    toggleShowMore(btn.dataset.bucket);
  }
});

document.getElementById('resultsList').addEventListener('click', (e) => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action = btn.dataset.action;

  if (action === 'fav-copy') {
    const art = allArticles.find(a => a.id === btn.dataset.id);
    if (art) copyToClipboard(art.title, sanitizeUrl(art.link), btn);
  } else if (action === 'fav-remove') {
    removeFavorite(btn.dataset.link);
  }
});
</script>

</body>
</html>
